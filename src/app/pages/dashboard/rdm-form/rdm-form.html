<!-- src/app/pages/dashboard/rdm-form/rdm-form.html -->
<div class="form-container">
  <header class="form-header">
    <h1 class="form-title">Nova Solicitação RDM</h1>

    <button type="button" class="btn btn-copy-rdm" (click)="openSearchModal()">
      <mat-icon>search</mat-icon>
      Buscar RDM
    </button>

    <p class="form-help">
      Para tirar dúvidas entrar em contato via
      <a href="https://teams.microsoft.com/l/chat/0/0?users=bruno-oliveira@apoioprodesp.sp.gov.br" class="help-link"
        target="_blank" rel="noopener" title="Link Teams Bruno Tome">
        Teams
      </a>
    </p>
  </header>

  <!-- Progresso -->
  <nav class="form-progress" aria-label="Progresso do formulário">
    <div class="progress-steps">
      @for (step of steps; track step.number; let i = $index) {
      <button type="button" class="step-btn" [class.active]="currentStep === step.number"
        (click)="goToStep(step.number)" [attr.aria-current]="currentStep === step.number ? 'step' : null">
        {{step.number}}. {{step.label}}
      </button>
      }
    </div>
    <div class="progress-bar">
      <div class="progress-fill" [style.width]="(currentStep / totalSteps) * 100 + '%'"
        [attr.aria-valuenow]="currentStep" [attr.aria-valuemin]="1" [attr.aria-valuemax]="totalSteps">
      </div>
    </div>
  </nav>

  <!-- Formulário -->
  <form (ngSubmit)="onSubmit()" #requestForm="ngForm" class="rdm-form">

    <!-- Passo 1: Identificação -->
    @if (currentStep === 1) {
    <fieldset class="form-section" aria-labelledby="step1-title">
      <legend id="step1-title">1. Identificação da Solicitação</legend>

      <div class="form-group">
        <label class="form-label" for="request-type">
          Tipo <span class="required">*</span>
        </label>
        <select class="form-control" id="request-type" [(ngModel)]="formData.identification.Type"
          name="identification.Type" required>
          @for (type of requestTypes; track type.value) {
          <option [value]="type.value">{{ type.label }}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="request-title">
          Título <span class="required">*</span>
        </label>
        <input type="text" class="form-control" id="request-title" [(ngModel)]="formData.identification.Title"
          name="identification.Title" placeholder="Ex: Ajuste no sistema" required>
      </div>
    </fieldset>
    }

    <!-- Passo 2: Objetivo -->
    @if (currentStep === 2) {
    <fieldset class="form-section" aria-labelledby="step2-title">
      <legend id="step2-title">2. Objetivo da Solução</legend>

      <div class="form-group">
        <label class="form-label" for="objective-solution">
          Objetivo e/ou Solução Proposta<span class="required">*</span>
          <span class="form-hint">(Descreva a solução ou objetivo esperado)</span>
        </label>
        <textarea class="form-control" id="objective-solution" [(ngModel)]="formData.solution.ObjectiveOrSolution"
          name="solution.ObjectiveOrSolution"
          placeholder="Descreva de forma clara o objetivo que se pretende alcançar e, se aplicável, a solução proposta para atender à demanda identificada."
          rows="6" required></textarea>
      </div>
    </fieldset>
    }

    <!-- Passo 3: Categorização -->
    @if (currentStep === 3) {
    <fieldset class="form-section" aria-labelledby="step3-title">
      <legend id="step3-title">3. Categorização</legend>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label" for="category-objective">Objetivo</label>
          <select class="form-control" id="category-objective" [(ngModel)]="formData.category.Objective"
            name="category.Objective">
            @for (obj of objectiveTypes; track obj.value) {
            <option [value]="obj.value">{{ obj.label }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="category-action">Ação</label>
          <select class="form-control" id="category-action" [(ngModel)]="formData.category.Action"
            name="category.Action">
            @for (action of actionTypes; track action.value) {
            <option [value]="action.value">{{ action.label }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="category-impact">Impacto</label>
          <select class="form-control" id="category-impact" [(ngModel)]="formData.category.Impact"
            name="category.Impact">
            @for (impact of levelTypes; track impact.value) {
            <option [value]="impact.value">{{ impact.label }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="category-urgency">Urgência</label>
          <select class="form-control" id="category-urgency" [(ngModel)]="formData.category.Urgency"
            name="category.Urgency">
            @for (urgency of levelTypes; track urgency.value) {
            <option [value]="urgency.value">{{ urgency.label }}</option>
            }
          </select>
        </div>
      </div>
    </fieldset>
    }

    <!-- Passo 4: Categoria de Impacto -->
    @if (currentStep === 4) {
    <fieldset class="form-section" aria-labelledby="step4-title">
      <legend id="step4-title">4. Categoria de Impacto</legend>

      <div class="form-group">
        <label class="form-label" for="change-system">
          Servidor/Sistema
          <span class="form-hint">(Qual sistema será alterado?)</span>
        </label>
        <input type="text" class="form-control" id="change-system" [(ngModel)]="formData.impactCategory.ChangeSystem"
          name="impactCategory.ChangeSystem" placeholder="Ex: Sistema de Controle de Acesso">
      </div>

      <div class="form-row">
        <div class="form-group half">
          <label class="form-label" for="activity-type">Atividade</label>
          <select class="form-control" id="activity-type" [(ngModel)]="formData.impactCategory.Activity"
            name="impactCategory.Activity">
            @for (activity of activityTypes; track activity.value) {
            <option [value]="activity.value">{{ activity.label }}</option>
            }
          </select>
        </div>

        <div class="form-group half">
          <label class="form-label" for="environment">Ambiente</label>
          <select class="form-control" id="environment" [(ngModel)]="formData.impactCategory.Environment"
            name="impactCategory.Environment">
            @for (env of environmentTypes; track env.value) {
            <option [value]="env.value">{{ env.label }}</option>
            }
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="impacted-services">
          Serviços Impactados
          <span class="form-hint">(Quais serviços serão afetados?)</span>
        </label>
        <input type="text" class="form-control" id="impacted-services"
          [(ngModel)]="formData.impactCategory.ImpactedServices" name="impactCategory.ImpactedServices"
          placeholder="Ex: Login, Relatórios, API">
      </div>

      <div class="form-group">
        <label class="form-label" for="ics-impacted">
          ICs Impactados
          <span class="form-hint">(Itens de Configuração impactados)</span>
        </label>
        <input type="text" class="form-control" id="ics-impacted" [(ngModel)]="formData.impactCategory.ICsImpacted"
          name="impactCategory.ICsImpacted" placeholder="Ex: Servidor, Banco de Dados">
      </div>
    </fieldset>
    }

    <!-- Passo 5: Janela de Implantação -->
    @if (currentStep === 5) {
    <fieldset class="form-section" aria-labelledby="step5-title">
      <legend id="step5-title">5. Janela de Implantação</legend>

      <div class="form-group">
        <label class="form-label" for="impact-type">Tipo de Impacto</label>
        <select class="form-control" id="impact-type" [(ngModel)]="formData.deploymentWindow.ImpactType"
          name="deploymentWindow.ImpactType">
          @for (impact of impactTypeOptions; track impact.value) {
          <option [value]="impact.value">{{ impact.label }}</option>
          }
        </select>
      </div>
    </fieldset>
    }

    <!-- Passo 6: Plano de Comunicação -->
    @if (currentStep === 6) {
    <fieldset class="form-section" aria-labelledby="step6-title">
      <legend id="step6-title">6. Plano de Comunicação</legend>

      <div class="form-group">
        <label class="form-label" for="whos-notified">
          Quem Será Notificado
          <span class="form-hint">(Liste as pessoas ou equipes a serem notificadas)</span>
        </label>
        <input type="text" class="form-control" id="whos-notified" [(ngModel)]="formData.planComunication.WhosNotified"
          name="planComunication.WhosNotified" placeholder="Ex: Equipe de TI, Usuários do Sistema X">
      </div>

      <div class="form-row">
        <div class="form-group half">
          <label class="form-label" for="moment">Momento da Comunicação</label>
          <select class="form-control" id="moment" [(ngModel)]="formData.planComunication.Moment"
            name="planComunication.Moment">
            @for (moment of momentOptions; track moment.value) {
            <option [value]="moment.value">{{ moment.label }}</option>
            }
          </select>
        </div>

        <div class="form-group half">
          <label class="form-label" for="comunication-type">Meio utilizado</label>
          <select class="form-control" id="comunication-type" [(ngModel)]="formData.planComunication.ComunicationType"
            name="planComunication.ComunicationType">
            @for (comm of comunicationTypeOptions; track comm.value) {
            <option [value]="comm.value">{{ comm.label }}</option>
            }
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="comunication-tech-area">Responsável</label>
        <select class="form-control" id="comunication-tech-area" [(ngModel)]="formData.planComunication.TechnologyArea"
          name="planComunication.TechnologyArea">
          <option value="">Selecione...</option>
          <option value="BancoDeDados">Banco de Dados</option>
          <option value="Linux">Linux</option>
          <option value="Windows">Windows</option>
          <option value="Redes">Redes</option>
        </select>
      </div>
    </fieldset>
    }

    <!-- Passo 7: Fases do Projeto -->
    @if (currentStep === 7) {
    <fieldset class="form-section" aria-labelledby="step7-title">
      <legend id="step7-title">7. Fases do Projeto</legend>

      <div class="form-subsection">
        <h4>Planejamento</h4>
        <div class="form-group">
          <label class="form-label" for="planning-wasPlanned">A fase de planejamento foi realizada?</label>
          <select class="form-control" id="planning-wasPlanned" [(ngModel)]="formData.phases.planning.WasPlanned"
            name="phases.planning.WasPlanned">
            <option value="">Selecione...</option>
            <option value="SIM">Sim</option>
            <option value="NAO">Não</option>
          </select>
        </div>

        <!-- Justificativa para Planejamento (só aparece quando for NÃO) -->
        @if (formData.phases.planning.WasPlanned === 'NAO') {
        <div class="form-group">
          <label class="form-label" for="planning-justification">Justificativa da ausência de planejamento</label>
          <textarea class="form-control" id="planning-justification"
            [(ngModel)]="formData.phases.planning.JustificationPlanned" name="phases.planning.JustificationPlanned"
            placeholder="Explique por que a fase de planejamento não foi realizada." rows="3"></textarea>
        </div>
        }
      </div>

      <div class="form-subsection">
        <h4>Teste / Homologação</h4>
        <div class="form-group">
          <label class="form-label" for="test-wasTested">A fase de testes/homologação foi realizada?</label>
          <select class="form-control" id="test-wasTested" [(ngModel)]="formData.phases.testHomology.WasTested"
            name="phases.testHomology.WasTested">
            <option value="">Selecione...</option>
            <option value="SIM">Sim</option>
            <option value="NAO">Não</option>
          </select>
        </div>

        <!-- Justificativa para Teste (só aparece quando for NÃO) -->
        @if (formData.phases.testHomology.WasTested === 'NAO') {
        <div class="form-group">
          <label class="form-label" for="test-justification">Justificativa da ausência de testes</label>
          <textarea class="form-control" id="test-justification"
            [(ngModel)]="formData.phases.testHomology.JustificationTest" name="phases.testHomology.JustificationTest"
            placeholder="Informe o motivo pelo qual a fase de testes/homologação não foi executada."
            rows="3"></textarea>
        </div>
        }
      </div>

      <div class="form-subsection">
        <h4>Execução</h4>
        <div class="form-row">
          <div class="form-group half">
            <label class="form-label" for="execute-stage">Em que momento</label>
            <select class="form-control" id="execute-stage" [(ngModel)]="formData.phases.execute.stage"
              name="phases.execute.stage">
              @for (stage of stageOptions; track stage.value) {
              <option [value]="stage.value">{{ stage.label }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group half">
            <label class="form-label" for="execute-start">Data e hora de início</label>
            <input type="datetime-local" class="form-control" id="execute-start"
              [(ngModel)]="formData.phases.execute.startDate" name="phases.execute.startDate">
          </div>
          <div class="form-group half">
            <label class="form-label" for="execute-end">Data e hora de término</label>
            <input type="datetime-local" class="form-control" id="execute-end"
              [(ngModel)]="formData.phases.execute.endDate" name="phases.execute.endDate">
          </div>
        </div>
      </div>

      <div class="form-subsection">
        <h4>Validação</h4>
        <div class="form-row">
          <div class="form-group half">
            <label class="form-label" for="validation-stage">Momento da validação</label>
            <select class="form-control" id="validation-stage" [(ngModel)]="formData.phases.validation.stage"
              name="phases.validation.stage">
              @for (stage of stageOptions; track stage.value) {
              <option [value]="stage.value">{{ stage.label }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group half">
            <label class="form-label" for="validation-start">Data e hora de início</label>
            <input type="datetime-local" class="form-control" id="validation-start"
              [(ngModel)]="formData.phases.validation.startDate" name="phases.validation.startDate">
          </div>
          <div class="form-group half">
            <label class="form-label" for="validation-end">Data e hora de término</label>
            <input type="datetime-local" class="form-control" id="validation-end"
              [(ngModel)]="formData.phases.validation.endDate" name="phases.validation.endDate">
          </div>
        </div>
      </div>
    </fieldset>
    }

    <!-- Passo 8: Planejamento -->
    @if (currentStep === 8) {
    <fieldset class="form-section" aria-labelledby="step8-title">
      <legend id="step8-title">8. Planejamento</legend>

      <div class="form-subsection">
        <h4>Planejamento de Execução</h4>
        <div class="form-group">
          <label class="form-label" for="execution-activity">
            Atividade(s)
            <span class="form-hint">(Descreva as atividades de execução)</span>
          </label>
          <textarea class="form-control" id="execution-activity" [(ngModel)]="formData.planningExecutation.Ativity"
            name="planningExecutation.Ativity" placeholder="Descreva as atividades planejadas para execução..."
            rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label class="form-label" for="execution-tech-area">Executor(es)</label>
            <select class="form-control" id="execution-tech-area"
              [(ngModel)]="formData.planningExecutation.TechnologyArea" name="planningExecutation.TechnologyArea">
              @for (tech of technologyAreaOptions; track tech.value) {
              <option [value]="tech.value">{{ tech.label }}</option>
              }
            </select>
          </div>

          <div class="form-group half">
            <label class="form-label" for="execution-probability">Probabilidade de Sucesso</label>
            <select class="form-control" id="execution-probability"
              [(ngModel)]="formData.planningExecutation.ProbabilityOfSuccess"
              name="planningExecutation.ProbabilityOfSuccess">
              @for (prob of levelTypes; track prob.value) {
              <option [value]="prob.value">{{ prob.label }}</option>
              }
            </select>
          </div>
        </div>
      </div>

      <div class="form-subsection">
        <h4>Planejamento de Remediação</h4>
        <div class="form-group">
          <label class="form-label" for="remediation-activity">
            Atividade(s)
            <span class="form-hint">(Descreva as atividades de remediação em caso de falha)</span>
          </label>
          <textarea class="form-control" id="remediation-activity" [(ngModel)]="formData.PlanningRemediation.Ativity"
            name="PlanningRemediation.Ativity" placeholder="Descreva o plano de remediação em caso de problemas..."
            rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label class="form-label" for="remediation-tech-area">Executor(es)</label>
            <select class="form-control" id="remediation-tech-area"
              [(ngModel)]="formData.PlanningRemediation.TechnologyArea" name="PlanningRemediation.TechnologyArea">
              @for (tech of technologyAreaOptions; track tech.value) {
              <option [value]="tech.value">{{ tech.label }}</option>
              }
            </select>
          </div>

          <div class="form-group half">
            <label class="form-label" for="remediation-probability">Probabilidade de Sucesso</label>
            <select class="form-control" id="remediation-probability"
              [(ngModel)]="formData.PlanningRemediation.ProbabilityOfSuccess"
              name="PlanningRemediation.ProbabilityOfSuccess">
              @for (prob of levelTypes; track prob.value) {
              <option [value]="prob.value">{{ prob.label }}</option>
              }
            </select>
          </div>
        </div>
      </div>
    </fieldset>
    }

    <!-- Passo 9: Anexos -->
    @if (currentStep === 9) {
    <fieldset class="form-section" aria-labelledby="step9-title">
      <legend id="step9-title">9. Anexos (Opcional)</legend>

      <div class="form-info-box">
        <p><strong>Importante:</strong> Apenas arquivos ZIP são permitidos.
          Tamanho máximo: <strong>5MB</strong></p>
      </div>

      <div class="form-group">
        <label class="form-label" for="attachments">
          Selecione o Arquivo ZIP
          <span class="form-hint">(Opcional - apenas .zip é permitido)</span>
        </label>

        <div class="file-upload-area" (click)="fileInput.click()" role="button" tabindex="0">
          <div class="file-upload-content">
            <svg class="file-upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" />
            </svg>
            <p class="file-upload-text">Clique para selecionar arquivo ZIP</p>
            <p class="file-upload-subtext">Opcional - apenas arquivos .zip são permitidos</p>
          </div>
          <input #fileInput type="file" id="attachments" (change)="onFileSelected($event)" accept=".zip" hidden>
        </div>

        @if (selectedFiles.length > 0) {
        <div class="file-list">
          <h4>Arquivo selecionado:</h4>
          @for (file of selectedFiles; track file.name; let i = $index) {
          <div class="file-item">
            <div class="file-info">
              <span class="file-name">{{ file.name }}</span>
              <span class="file-size">{{ getFileSize(file.size) }}</span>
            </div>
            <button type="button" class="file-remove" (click)="removeFile(i)" aria-label="Remover arquivo">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          }
        </div>
        } @else {
        <p class="file-info-note" role="status">
          Nenhum arquivo selecionado.
        </p>
        }
      </div>
    </fieldset>
    }

    <!-- Navegação -->
    <div class="form-navigation">
      @if (currentStep > 1) {
      <button type="button" class="btn btn-secondary" (click)="previousStep()">
        <mat-icon>arrow_back</mat-icon> Voltar
      </button>
      }

      @if (currentStep < totalSteps) { <button type="button" class="btn btn-primary" (click)="nextStep()"
        [disabled]="!isStepValid(currentStep)">
        Próximo <mat-icon>arrow_forward</mat-icon>
        </button>
        }

        @if (currentStep === totalSteps) {
        <button type="submit" class="btn btn-primary" [disabled]="isLoading || !requestForm.valid">
          @if (!isLoading) {
          <mat-icon>send</mat-icon> Enviar Solicitação RDM
          } @else {
          <span class="spinner"></span> Enviando...
          }
        </button>
        }
    </div>

    <!-- Mensagens -->
@if (errorMessages && errorMessages.length > 0) {
<div class="alert alert-error" role="alert">
  <mat-icon>error</mat-icon>
  <div class="error-content">
    <p>Foram encontrados os seguintes erros:</p>
    <ul>
      @for (msg of errorMessages; track $index) {
      <li>{{ msg }}</li>
      }
    </ul>
  </div>
</div>
}

    @if (successMessage) {
    <div class="alert alert-success" role="alert">
      <mat-icon>check_circle</mat-icon> {{ successMessage }}
    </div>
    }
  </form>

  <!-- Reset -->
  <footer class="form-footer">
    <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="isLoading">
      <mat-icon>delete</mat-icon> Limpar Formulário
    </button>

    <p class="required-info">
      <span class="required">*</span> Campos obrigatórios
    </p>
  </footer>

  <!-- Modal de Sucesso -->
  @if (showSuccessModal) {
  <div class="modal-overlay" role="dialog" aria-modal="true" (click)="closeSuccessModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-success-icon">✓</div>
      <h2>Solicitação Enviada com Sucesso!</h2>

      <p>Sua solicitação RDM foi registrada e está em análise.</p>

      <div class="solicitation-info">
        <p><strong>Ticket:</strong> <code class="ticket-code"> {{ solicitationTicket }}</code></p>
      </div>

      <p>Você pode acompanhar o status através da seção <strong>"Minhas Solicitações"</strong>.</p>
      <p>Você receberá notificações sobre as atualizações.</p>

      <div class="modal-actions">
        <button class="btn btn-primary" (click)="closeSuccessModal()">Entendido</button>
        <button class="btn btn-secondary" (click)="resetAndClose()">Enviar Nova Solicitação</button>
      </div>
    </div>
  </div>
  }

  <!-- Modal de Busca -->
  @if (showSearchModal) {
  <div class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="search-modal-title"
    (click)="closeSearchModal()">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3 id="search-modal-title">Buscar RDM</h3>
        <button class="modal-close" (click)="closeSearchModal()" aria-label="Fechar" type="button">
          <mat-icon>close</mat-icon>
        </button>
      </header>

      <div class="modal-body">
        <div class="search-modal-content">
          <div class="search-input-group">
            <label for="ticket-search" class="form-label">
              Digite o código do ticket da RDM existente:
            </label>
            <div class="input-with-button">
              <input type="text" id="ticket-search" [(ngModel)]="searchTicket" (input)="onTicketInput()"
                placeholder="Ex: RDM-20260107-7d887283" class="form-control" (keyup.enter)="searchExistingRDM()"
                [disabled]="isSearching" />
              <button type="button" class="btn btn-search" (click)="searchExistingRDM()"
                [disabled]="!searchTicket || isSearching">
                @if (isSearching) {
                <span class="spinner spinner-small"></span>
                } @else {
                <mat-icon>search</mat-icon>
                }
                Buscar
              </button>
            </div>
            <p class="form-hint">Cole o código completo do ticket (incluindo o prefixo "RDM-")</p>
          </div>

          @if (searchError) {
          <div class="alert alert-error" role="alert">
            <mat-icon>error</mat-icon> {{ searchError }}
          </div>
          }

          @if (foundRDM) {
          <div class="found-rdm-info">
            <div class="alert alert-success">
              <mat-icon>check_circle</mat-icon> RDM encontrada!
            </div>

            <div class="rdm-preview">
              <h4>Detalhes da RDM encontrada:</h4>
              <dl class="rdm-preview-details">
                <dt>Ticket:</dt>
                <dd>{{ foundRDM.ticket }}</dd>
                <dt>Título:</dt>
                <dd>{{ foundRDM.identification?.title || 'N/A' }}</dd>
                <dt>Tipo:</dt>
                <dd>{{ foundRDM.identification?.type || 'N/A' }}</dd>
                <dt>Área:</dt>
                <dd>{{ foundRDM.identification?.area || 'N/A' }}</dd>
                <dt>Data:</dt>
                <dd>{{ foundRDM.date | date:'dd/MM/yyyy' }}</dd>
              </dl>

              <div class="preview-warning" role="alert">
                <mat-icon>warning</mat-icon>
                <p>Ao clicar em "Copiar Dados", todos os campos do formulário atual serão preenchidos com os dados desta
                  RDM.</p>
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn btn-secondary" (click)="copyRDMData()" [disabled]="isCopying">
                @if (isCopying) {
                <span class="spinner spinner-small"></span> Copiando...
                } @else {
                <mat-icon>content_copy</mat-icon> Copiar Dados
                }
              </button>
              <button type="button" class="btn btn-primary" (click)="closeSearchModal()">
                <mat-icon>close</mat-icon> Cancelar
              </button>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
  </div>
  }
</div>
