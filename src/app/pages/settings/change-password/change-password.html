<div class="container-content-dashboard">
  <div class="change-password-container">
    <div class="card">
      <!-- Cabeçalho -->
      <div class="card-header">
        <h1 class="card-title">
          Alterar Senha
        </h1>
        <p class="card-subtitle">Atualize sua senha de acesso</p>
      </div>

      <div class="card-body">
        <!-- Perfil do Usuário -->
        <div class="user-profile-section">
          <div class="user-avatar">
            {{ userInitials$ | async }}
          </div>
          <div class="user-info">
            <h3>{{ (userProfile$ | async)?.name || 'Usuário' }}</h3>
            <div class="user-details">
              @if ((userProfile$ | async)?.email) {
              <div class="detail-item">
                <mat-icon>email</mat-icon>
                <span>{{ (userProfile$ | async)?.email }}</span>
              </div>
              }
            </div>
          </div>
        </div>

        <!-- Mensagens -->
        @if (errorMessage) {
        <div class="alert alert-error" role="alert">
          <mat-icon>error</mat-icon>
          <span>{{ errorMessage }}</span>
        </div>
        }

        @if (successMessage) {
        <div class="alert alert-success" role="alert">
          <mat-icon>check_circle</mat-icon>
          <span>{{ successMessage }}</span>
        </div>
        }

        <!-- Formulário -->
        <form [formGroup]="changePasswordForm" (ngSubmit)="onSubmit()" class="password-form">
          <!-- Senha Atual -->
          <div class="form-field">
            <label for="currentPassword" class="form-label">
              <mat-icon>lock</mat-icon>
              Senha Atual
              <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <input type="password" id="currentPassword" formControlName="currentPassword"
                placeholder="Digite sua senha atual"
                [class.error]="currentPasswordControl?.invalid && (currentPasswordControl?.touched || formSubmitted)"
                aria-describedby="currentPasswordError">
            </div>
            @if (currentPasswordControl?.invalid && (currentPasswordControl?.touched || formSubmitted)) {
            <div id="currentPasswordError" class="error-message">
              <mat-icon>error</mat-icon>
              @if (currentPasswordControl?.errors?.['required']) {
              <span>Campo obrigatório</span>
              }
            </div>
            }
          </div>

          <!-- Nova Senha -->
          <div class="form-field">
            <label for="newPassword" class="form-label">
              <mat-icon>lock_open</mat-icon>
              Nova Senha
              <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <input type="password" id="newPassword" formControlName="newPassword" placeholder="Mínimo 8 caracteres"
                (input)="onPasswordChange()"
                [class.error]="newPasswordControl?.invalid && (newPasswordControl?.touched || formSubmitted)"
                aria-describedby="newPasswordError passwordStrength">
            </div>

            <!-- Validação da Senha -->
            @if (newPasswordControl?.value && passwordValidations) {
            <div id="passwordStrength" class="password-validation">
              <div class="validation-item" [class.valid]="passwordValidations.hasUpperCase">
                <mat-icon>{{ passwordValidations.hasUpperCase ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                <span>Letra maiúscula</span>
              </div>
              <div class="validation-item" [class.valid]="passwordValidations.hasLowerCase">
                <mat-icon>{{ passwordValidations.hasLowerCase ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                <span>Letra minúscula</span>
              </div>
              <div class="validation-item" [class.valid]="passwordValidations.hasNumbers">
                <mat-icon>{{ passwordValidations.hasNumbers ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                <span>Número</span>
              </div>
              <div class="validation-item" [class.valid]="passwordValidations.hasSpecialChar">
                <mat-icon>{{ passwordValidations.hasSpecialChar ? 'check_circle' : 'radio_button_unchecked'
                  }}</mat-icon>
                <span>Caractere especial (@$!%*?&)</span>
              </div>
              <div class="validation-item" [class.valid]="passwordValidations.isValidLength">
                <mat-icon>{{ passwordValidations.isValidLength ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                <span>Mínimo 8 caracteres</span>
              </div>

              <!-- Barra de Força -->
              <div class="strength-meter">
                <div class="strength-bar">
                  <div class="strength-fill" [style.width.%]="passwordStrength"></div>
                </div>
                <div class="strength-label">
                  @if (passwordStrength === 100) {
                  <span class="strength-strong">Senha forte</span>
                  } @else if (passwordStrength > 60) {
                  <span class="strength-medium">Força: {{ passwordStrength }}%</span>
                  } @else {
                  <span class="strength-weak">Força: {{ passwordStrength }}%</span>
                  }
                </div>
              </div>
            </div>
            }

            @if (newPasswordControl?.invalid && (newPasswordControl?.touched || formSubmitted)) {
            <div id="newPasswordError" class="error-message">
              <mat-icon>error</mat-icon>
              @if (newPasswordControl?.errors?.['required']) {
              <span>Campo obrigatório</span>
              }
              @if (newPasswordControl?.errors?.['minlength']) {
              <span>Mínimo 8 caracteres</span>
              }
            </div>
            }
          </div>

          <!-- Confirmar Senha -->
          <div class="form-field">
            <label for="confirmPassword" class="form-label">
              <mat-icon>lock_reset</mat-icon>
              Confirmar Senha
              <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <input type="password" id="confirmPassword" formControlName="confirmPassword"
                placeholder="Confirme a nova senha"
                [class.error]="(confirmPasswordControl?.invalid || passwordsMismatch) && (confirmPasswordControl?.touched || formSubmitted)"
                aria-describedby="confirmPasswordError">
            </div>
            @if (passwordsMismatch && (confirmPasswordControl?.touched || formSubmitted)) {
            <div class="error-message">
              <mat-icon>error</mat-icon>
              <span>As senhas não coincidem</span>
            </div>
            }
          </div>

          <!-- Ações -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="goBack()" [disabled]="isLoading">
              <mat-icon>arrow_back</mat-icon>
              <span>Voltar</span>
            </button>

            <button type="submit" class="btn btn-primary"
              [disabled]="isLoading || changePasswordForm.invalid || passwordsMismatch">
              @if (isLoading) {
              <div class="loading-spinner">
                <mat-icon class="spinner">refresh</mat-icon>
              </div>
              <span>Processando...</span>
              } @else {
              <mat-icon>save</mat-icon>
              <span>Alterar Senha</span>
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
